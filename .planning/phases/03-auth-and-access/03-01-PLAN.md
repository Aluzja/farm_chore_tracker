---
phase: 03-auth-and-access
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/convex/schema.ts
  - src/convex/auth.config.ts
  - src/convex/auth.ts
  - src/convex/http.ts
autonomous: false

user_setup:
  - service: convex-auth
    why: "JWT keys for admin authentication"
    env_vars:
      - name: JWT_PRIVATE_KEY
        source: "Run `npx @convex-dev/auth` and follow prompts, or generate with openssl"
      - name: JWKS
        source: "Generated alongside JWT_PRIVATE_KEY"
      - name: SITE_URL
        source: "Set to your deployment URL (e.g., http://localhost:5173 for dev)"

must_haves:
  truths:
    - "Convex Auth is configured with Password provider"
    - "Schema includes authTables and accessKeys table"
    - "Admin user can be created via first sign-up"
  artifacts:
    - path: "src/convex/auth.config.ts"
      provides: "Auth provider configuration"
      contains: "providers"
    - path: "src/convex/auth.ts"
      provides: "Convex Auth setup with Password provider"
      exports: ["auth", "signIn", "signOut", "store", "isAuthenticated"]
    - path: "src/convex/http.ts"
      provides: "HTTP router with auth routes"
      contains: "httpRouter"
    - path: "src/convex/schema.ts"
      provides: "Schema with authTables and accessKeys"
      contains: ["authTables", "accessKeys"]
  key_links:
    - from: "src/convex/http.ts"
      to: "src/convex/auth.ts"
      via: "auth.addHttpRoutes(http)"
      pattern: "addHttpRoutes"
    - from: "src/convex/schema.ts"
      to: "@convex-dev/auth"
      via: "authTables spread"
      pattern: "\\.\\.\\.authTables"
---

<objective>
Set up Convex Auth infrastructure with Password provider and extend schema for auth

Purpose: Establish the authentication foundation that enables admin login and access key management. This is the prerequisite for all other auth work in this phase.

Output:
- Convex Auth configured with Password provider
- Schema extended with authTables and accessKeys table
- HTTP router handling auth endpoints
- First user becomes admin pattern established
</objective>

<execution_context>
@/Users/mike.wojnarowski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike.wojnarowski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-auth-and-access/03-RESEARCH.md

# Current schema for reference
@src/convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Convex Auth dependencies</name>
  <files>package.json</files>
  <action>
Install the required packages for Convex Auth:

```bash
bun add @convex-dev/auth @auth/core@0.37.0
```

IMPORTANT: Pin @auth/core to exactly 0.37.0 as required by @convex-dev/auth.

Verify installation completes without errors.
  </action>
  <verify>
`bun pm ls @convex-dev/auth` shows package installed.
`bun pm ls @auth/core` shows version 0.37.0.
  </verify>
  <done>Both @convex-dev/auth and @auth/core@0.37.0 are installed in package.json</done>
</task>

<task type="auto">
  <name>Task 2: Create Convex Auth configuration files</name>
  <files>
src/convex/auth.config.ts
src/convex/auth.ts
src/convex/http.ts
  </files>
  <action>
Create three files for Convex Auth setup:

**src/convex/auth.config.ts:**
```typescript
export default {
  providers: [
    {
      domain: process.env.CONVEX_SITE_URL,
      applicationID: "convex",
    },
  ],
};
```

**src/convex/auth.ts:**
```typescript
import { convexAuth } from "@convex-dev/auth/server";
import Password from "@convex-dev/auth/providers/Password";

export const { auth, signIn, signOut, store, isAuthenticated } = convexAuth({
  providers: [Password],
});
```

**src/convex/http.ts:**
```typescript
import { httpRouter } from "convex/server";
import { auth } from "./auth";

const http = httpRouter();
auth.addHttpRoutes(http);

export default http;
```

These files follow the Convex Auth manual setup pattern for non-React frameworks.
  </action>
  <verify>
All three files exist with correct imports:
- `cat src/convex/auth.config.ts` shows providers array
- `cat src/convex/auth.ts` shows convexAuth with Password provider
- `cat src/convex/http.ts` shows httpRouter with auth routes
  </verify>
  <done>Convex Auth files created with Password provider configuration</done>
</task>

<task type="auto">
  <name>Task 3: Extend schema with authTables and accessKeys</name>
  <files>src/convex/schema.ts</files>
  <action>
Update the Convex schema to include:
1. Spread `authTables` from @convex-dev/auth/server for session management
2. Add `users` table extension with `isAdmin` boolean (first user is admin)
3. Add `accessKeys` table for URL-based worker access

The schema should look like:

```typescript
import { defineSchema, defineTable } from "convex/server";
import { authTables } from "@convex-dev/auth/server";
import { v } from "convex/values";

export default defineSchema({
  ...authTables,

  // Extend users table with admin flag
  users: defineTable({
    name: v.optional(v.string()),
    email: v.optional(v.string()),
    emailVerificationTime: v.optional(v.number()),
    image: v.optional(v.string()),
    isAdmin: v.boolean(), // First user becomes admin
  }).index("email", ["email"]),

  // Access keys for URL-based worker access
  accessKeys: defineTable({
    key: v.string(),                    // The shareable key (e.g., "abc123def456")
    displayName: v.string(),            // Human-readable name ("John's Phone")
    createdAt: v.number(),
    createdBy: v.id("users"),           // Admin who created this key
    revokedAt: v.optional(v.number()),  // Set when key is revoked
    lastUsedAt: v.optional(v.number()), // Track usage
  })
    .index("by_key", ["key"])
    .index("by_created_by", ["createdBy"]),

  // Existing tables
  chores: defineTable({
    clientId: v.string(),
    text: v.string(),
    isCompleted: v.boolean(),
    completedAt: v.optional(v.string()),
    completedBy: v.optional(v.string()),
    lastModified: v.number(),
  })
    .index("by_last_modified", ["lastModified"])
    .index("by_client_id", ["clientId"]),

  // Keep tasks for backwards compatibility
  tasks: defineTable({
    text: v.string(),
    isCompleted: v.boolean(),
  }),
});
```

IMPORTANT: The `users` table definition must match authTables structure but add the `isAdmin` field. The authTables spread provides the base fields.
  </action>
  <verify>
`bunx convex dev --once` successfully deploys schema changes.
Check that schema includes:
- authTables spread
- accessKeys table with by_key index
- users table with isAdmin field
  </verify>
  <done>Schema extended with authTables, users.isAdmin, and accessKeys table</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Set up Convex Auth environment variables</action>
  <instructions>
Convex Auth requires JWT keys for token signing. These must be set in your Convex dashboard.

**Option 1: Use the Convex Auth CLI helper**
```bash
npx @convex-dev/auth
```
Follow the prompts to generate and configure keys.

**Option 2: Manual setup**
1. Generate a private key:
   ```bash
   openssl genpkey -algorithm RSA -out private_key.pem -pkeyopt rsa_keygen_bits:2048
   ```
2. Extract the JWKS:
   ```bash
   openssl rsa -in private_key.pem -pubout -outform PEM
   ```
3. Go to Convex Dashboard -> Settings -> Environment Variables
4. Set these variables:
   - `JWT_PRIVATE_KEY`: Contents of private_key.pem
   - `JWKS`: The public key in JWKS format (or run the helper script)
   - `SITE_URL`: Your app URL (e.g., `http://localhost:5173` for dev)

**Verify:**
After setting environment variables, run:
```bash
bunx convex dev --once
```
If successful, auth endpoints are ready.
  </instructions>
  <resume-signal>Type "keys configured" when environment variables are set in Convex dashboard</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `bun run build` completes without errors
2. `bunx convex dev --once` deploys successfully
3. Schema shows authTables, users with isAdmin, and accessKeys table
4. HTTP router is registered with Convex
</verification>

<success_criteria>
- Convex Auth packages installed (@convex-dev/auth, @auth/core@0.37.0)
- Auth configuration files exist (auth.config.ts, auth.ts, http.ts)
- Schema includes authTables spread and accessKeys table
- Environment variables configured (JWT_PRIVATE_KEY, JWKS, SITE_URL)
- `bunx convex dev --once` deploys without auth-related errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-auth-and-access/03-01-SUMMARY.md`
</output>
