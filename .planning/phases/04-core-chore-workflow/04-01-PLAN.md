---
phase: 04-core-chore-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/convex/schema.ts
  - src/convex/masterChores.ts
  - src/convex/dailyChores.ts
  - src/lib/db/schema.ts
  - src/lib/db/client.ts
  - src/lib/utils/date.ts
autonomous: true

must_haves:
  truths:
    - "Convex schema includes masterChores and dailyChores tables"
    - "Master chore CRUD mutations are available for admin"
    - "Daily chore queries and mutations are available"
    - "IndexedDB schema supports daily chore offline storage"
  artifacts:
    - path: "src/convex/schema.ts"
      provides: "masterChores and dailyChores table definitions"
      contains: "masterChores: defineTable"
    - path: "src/convex/masterChores.ts"
      provides: "Admin CRUD for master chores"
      exports: ["list", "create", "update", "remove"]
    - path: "src/convex/dailyChores.ts"
      provides: "Daily list queries and mutations"
      exports: ["getOrCreateDailyList", "cloneMasterToDaily", "toggleComplete", "addAdHoc"]
    - path: "src/lib/db/schema.ts"
      provides: "DailyChore Zod schema for IndexedDB"
      contains: "DailyChoreSchema"
    - path: "src/lib/utils/date.ts"
      provides: "Date utilities for daily logic"
      exports: ["getTodayDateString", "formatTimeSlot", "getCurrentTimeSlot"]
  key_links:
    - from: "src/convex/dailyChores.ts"
      to: "src/convex/masterChores"
      via: "cloneMasterToDaily reads active master chores"
      pattern: 'query\\("masterChores"\\)'
---

<objective>
Extend Convex schema with masterChores and dailyChores tables, create the Convex API for CRUD operations, and extend IndexedDB schema for offline daily chore storage.

Purpose: Establish the data foundation for the two-table master/daily chore pattern that all subsequent plans depend on.
Output: Working Convex API for master and daily chores, updated IndexedDB schema.
</objective>

<execution_context>
@/Users/mike.wojnarowski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike.wojnarowski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-chore-workflow/04-RESEARCH.md

# Existing schema and patterns
@src/convex/schema.ts
@src/lib/db/schema.ts
@src/lib/db/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Convex schema with masterChores and dailyChores tables</name>
  <files>src/convex/schema.ts</files>
  <action>
Add two new tables to the Convex schema (keep existing tables unchanged):

**masterChores table:**
- text: v.string() - Chore description
- timeSlot: v.string() - "morning" | "afternoon" | "evening"
- animalCategory: v.string() - "chickens" | "goats" | "pigs" | "general" etc.
- sortOrder: v.number() - Display order within group
- isActive: v.boolean() - Soft delete / disable
- createdBy: v.optional(v.id("users")) - Admin who created
- createdAt: v.number()
- updatedAt: v.number()
- Indexes: by_time_slot (timeSlot), by_active (isActive)

**dailyChores table:**
- date: v.string() - ISO date "2026-02-02"
- masterChoreId: v.optional(v.id("masterChores")) - null for ad-hoc
- clientId: v.string() - For offline-first idempotency
- text: v.string()
- timeSlot: v.string()
- animalCategory: v.string()
- sortOrder: v.number()
- isCompleted: v.boolean()
- completedAt: v.optional(v.string()) - ISO datetime
- completedBy: v.optional(v.string()) - Display name
- isAdHoc: v.boolean() - true for today-only chores
- lastModified: v.number()
- Indexes: by_date (date), by_date_time_slot (date, timeSlot), by_client_id (clientId)

Keep the existing chores table for now - it will be deprecated after migration.
  </action>
  <verify>Run `bunx convex dev --once` to deploy schema and verify no errors</verify>
  <done>Schema deployed with both new tables and indexes created in Convex</done>
</task>

<task type="auto">
  <name>Task 2: Create master chores Convex API and daily chores Convex API</name>
  <files>src/convex/masterChores.ts, src/convex/dailyChores.ts, src/lib/utils/date.ts</files>
  <action>
**Create src/lib/utils/date.ts:**
```typescript
export function getTodayDateString(): string {
  return new Date().toISOString().split('T')[0];
}

export function formatTimeSlot(slot: string): string {
  const labels: Record<string, string> = {
    morning: 'Morning',
    afternoon: 'Afternoon',
    evening: 'Evening',
  };
  return labels[slot] || slot;
}

export function getCurrentTimeSlot(): 'morning' | 'afternoon' | 'evening' {
  const hour = new Date().getHours();
  if (hour < 12) return 'morning';
  if (hour < 17) return 'afternoon';
  return 'evening';
}
```

**Create src/convex/masterChores.ts with:**
- `list` query: Get all master chores (admin only - check getAuthUserId + isAdmin)
- `create` mutation: Create master chore with auto sortOrder (admin only)
- `update` mutation: Update master chore fields (admin only)
- `remove` mutation: Soft delete via isActive=false (admin only)

Use getAuthUserId from @convex-dev/auth/server for auth checks.

**Create src/convex/dailyChores.ts with:**
- `getOrCreateDailyList` query: Get today's daily chores; return { needsClone: true, date } if none exist
- `cloneMasterToDaily` mutation: Clone active master chores to daily for a given date (idempotent - check if already cloned)
- `toggleComplete` mutation: Toggle isCompleted, set completedAt/completedBy, use lastModified for last-write-wins
- `addAdHoc` mutation: Add today-only chore with isAdHoc=true, auto sortOrder (idempotent via clientId)

For cloneMasterToDaily:
1. Check if any dailyChores exist for that date (if so, return existing)
2. Query masterChores with isActive=true
3. Insert each as dailyChore with crypto.randomUUID() for clientId
4. Return the created daily chores

For toggleComplete, look up by clientId (not Convex _id) for offline-first compatibility.
  </action>
  <verify>Run `bun run build` to verify no TypeScript errors. Run `bunx convex dev --once` to deploy functions.</verify>
  <done>Master and daily chore APIs deployed to Convex with admin-protected master CRUD and public daily operations</done>
</task>

<task type="auto">
  <name>Task 3: Extend IndexedDB schema for daily chores</name>
  <files>src/lib/db/schema.ts, src/lib/db/client.ts</files>
  <action>
**Update src/lib/db/schema.ts:**

Add DailyChoreSchema (mirrors Convex dailyChores but with local syncStatus):
```typescript
export const DailyChoreSchema = z.object({
  _id: z.string(), // clientId used as local _id
  date: z.string(),
  masterChoreId: z.string().optional(),
  text: z.string().min(1),
  timeSlot: z.string(),
  animalCategory: z.string(),
  sortOrder: z.number(),
  isCompleted: z.boolean(),
  completedAt: z.iso.datetime().optional(),
  completedBy: z.string().optional(),
  isAdHoc: z.boolean(),
  syncStatus: z.enum(['pending', 'synced', 'failed']),
  lastModified: z.number()
});

export type DailyChore = z.infer<typeof DailyChoreSchema>;
```

Add to STORES:
```typescript
export const STORES = {
  chores: 'chores',
  dailyChores: 'dailyChores', // Add this
  mutationQueue: 'mutationQueue'
} as const;
```

**Update src/lib/db/client.ts:**

Add dailyChores to KitchenSinkDB interface:
```typescript
dailyChores: {
  key: string;
  value: DailyChore;
  indexes: {
    'by-date': string;
    'by-sync-status': string;
  };
};
```

Increment DB_VERSION to 2 in schema.ts.

Add migration in upgrade function:
```typescript
if (oldVersion < 2) {
  const dailyStore = db.createObjectStore(STORES.dailyChores, { keyPath: '_id' });
  dailyStore.createIndex('by-date', 'date');
  dailyStore.createIndex('by-sync-status', 'syncStatus');
}
```

Import DailyChore type in client.ts.
  </action>
  <verify>Run `bun run build` to verify no TypeScript errors. Start dev server and check browser console for IndexedDB migration.</verify>
  <done>IndexedDB schema extended with dailyChores store, migration in place for version 2</done>
</task>

</tasks>

<verification>
1. `bunx convex dev --once` deploys schema and functions without errors
2. `bun run build` completes without TypeScript errors
3. Convex dashboard shows masterChores and dailyChores tables with correct indexes
4. API exports visible in src/convex/_generated/api.d.ts
</verification>

<success_criteria>
- masterChores table exists in Convex with by_time_slot and by_active indexes
- dailyChores table exists in Convex with by_date, by_date_time_slot, and by_client_id indexes
- Master chore CRUD mutations require admin authentication
- getOrCreateDailyList returns needsClone flag when no daily chores exist
- cloneMasterToDaily is idempotent (safe to call multiple times)
- IndexedDB version 2 migration creates dailyChores store
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-chore-workflow/04-01-SUMMARY.md`
</output>
