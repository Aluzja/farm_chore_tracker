---
phase: 04-core-chore-workflow
plan: 04
type: execute
wave: 3
depends_on: ["04-03"]
files_modified:
  - src/routes/(app)/+page.svelte
  - src/lib/stores/dailyChores.svelte.ts
  - src/routes/(app)/+layout.svelte
autonomous: true

must_haves:
  truths:
    - "User can add ad-hoc chore for today only"
    - "Ad-hoc chore appears in correct time slot and category"
    - "Ad-hoc chore is marked with 'Today only' badge"
    - "User name is properly passed to completion and ad-hoc creation"
  artifacts:
    - path: "src/routes/(app)/+page.svelte"
      provides: "Ad-hoc chore add button and form"
      contains: "handleAddAdHoc"
    - path: "src/lib/stores/dailyChores.svelte.ts"
      provides: "addAdHoc method on store"
      contains: "async addAdHoc"
  key_links:
    - from: "src/routes/(app)/+page.svelte"
      to: "src/lib/stores/dailyChores.svelte.ts"
      via: "dailyChoreStore.addAdHoc()"
      pattern: "dailyChoreStore\\.addAdHoc"
---

<objective>
Add ability for workers to create ad-hoc chores for today only, and properly pass user identity for completion attribution.

Purpose: Enable workers to track unexpected tasks that aren't on the master list.
Output: Add chore button/form and proper user identity flow.
</objective>

<execution_context>
@/Users/mike.wojnarowski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike.wojnarowski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-chore-workflow/04-RESEARCH.md

# Prior plan outputs
@.planning/phases/04-core-chore-workflow/04-01-SUMMARY.md
@.planning/phases/04-core-chore-workflow/04-03-SUMMARY.md

# Current implementation
@src/routes/(app)/+page.svelte
@src/lib/stores/dailyChores.svelte.ts
@src/routes/(app)/+layout.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add addAdHoc method to daily chore store</name>
  <files>src/lib/stores/dailyChores.svelte.ts</files>
  <action>
Add an `addAdHoc` method to DailyChoreStore for creating today-only chores:

```typescript
// Add ad-hoc chore for today
async addAdHoc(
  text: string,
  timeSlot: 'morning' | 'afternoon' | 'evening',
  animalCategory: string,
  createdBy: string
): Promise<string> {
  const now = Date.now();
  const clientId = crypto.randomUUID();

  // Calculate sortOrder (max + 1 for this time slot)
  const slotChores = this.items.filter(c => c.timeSlot === timeSlot);
  const maxOrder = Math.max(0, ...slotChores.map(c => c.sortOrder));

  const newChore: DailyChore = {
    _id: clientId,
    date: this.currentDate,
    masterChoreId: undefined,
    text,
    timeSlot,
    animalCategory: animalCategory || 'General',
    sortOrder: maxOrder + 1,
    isCompleted: false,
    isAdHoc: true,
    syncStatus: 'pending',
    lastModified: now,
  };

  // Optimistic update
  this.items = [...this.items, newChore];

  // Persist to IndexedDB
  await putDailyChore(newChore);

  // Queue for sync
  await enqueueMutation('create', 'dailyChores', {
    clientId: newChore._id,
    text: newChore.text,
    timeSlot: newChore.timeSlot,
    animalCategory: newChore.animalCategory,
    createdBy,
    lastModified: newChore.lastModified,
  });

  return clientId;
}
```

Also add a method to track pending deletes for ad-hoc (optional, for future delete feature):
```typescript
confirmDelete(id: string): void {
  this.pendingDeletes.delete(id);
}
```
  </action>
  <verify>Run `bun run check` to verify no TypeScript errors</verify>
  <done>addAdHoc method implemented on DailyChoreStore with optimistic update and sync queue</done>
</task>

<task type="auto">
  <name>Task 2: Pass user identity through layout and add ad-hoc form to page</name>
  <files>src/routes/(app)/+layout.svelte, src/routes/(app)/+page.svelte</files>
  <action>
**Update src/routes/(app)/+layout.svelte:**

Pass the userName to the page via Svelte context or snippet props. The simplest approach is to expose userName via a store or context that the page can access.

Option 1 (using setContext/getContext):
```typescript
import { setContext } from 'svelte';

// After userName is set...
setContext('userName', userName);
```

Option 2 (using a shared store - cleaner):
Create a small auth context store or just expose userName through snippet props if the layout uses snippets.

For simplicity, since layout already has userName in $state, expose it through a getter function in a module:

Create quick utility in layout or use existing adminAuth pattern. Simplest: just make userName accessible via a module-level export or store.

Actually, looking at the layout, it passes children via snippet. We can pass userName as a prop to the page via the page store or by setting it in a shared module.

**Simplest approach:** Create `src/lib/auth/user-context.svelte.ts`:
```typescript
// Simple reactive user context
let currentUserName = $state<string | null>(null);

export function setCurrentUser(name: string | null) {
  currentUserName = name;
}

export function getCurrentUser(): string {
  return currentUserName || 'Worker';
}
```

In layout's onMount success paths, call:
```typescript
import { setCurrentUser } from '$lib/auth/user-context.svelte';
// After validation succeeds...
setCurrentUser(userName);
```

**Update src/routes/(app)/+page.svelte:**

1. Import and use getCurrentUser:
```typescript
import { getCurrentUser } from '$lib/auth/user-context.svelte';

// Replace hardcoded 'Worker' with:
const userName = getCurrentUser();
```

2. Add ad-hoc chore form UI:

Add state for the form:
```typescript
let showAddForm = $state(false);
let newChoreText = $state('');
let newChoreTimeSlot = $state<'morning' | 'afternoon' | 'evening'>('morning');
let newChoreCategory = $state('General');

async function handleAddAdHoc() {
  if (!newChoreText.trim()) return;

  await dailyChoreStore.addAdHoc(
    newChoreText.trim(),
    newChoreTimeSlot,
    newChoreCategory,
    getCurrentUser()
  );

  // Reset form
  newChoreText = '';
  showAddForm = false;
}
```

Add UI after the header, before the chore list:
```svelte
<!-- Add chore button -->
<div class="add-section">
  {#if showAddForm}
    <form class="add-form" onsubmit={(e) => { e.preventDefault(); handleAddAdHoc(); }}>
      <input
        type="text"
        bind:value={newChoreText}
        placeholder="What needs to be done?"
        class="add-input"
        autofocus
      />
      <div class="form-row">
        <select bind:value={newChoreTimeSlot} class="time-select">
          <option value="morning">Morning</option>
          <option value="afternoon">Afternoon</option>
          <option value="evening">Evening</option>
        </select>
        <input
          type="text"
          bind:value={newChoreCategory}
          placeholder="Category"
          class="category-input"
        />
      </div>
      <div class="form-actions">
        <button type="button" class="cancel-btn" onclick={() => { showAddForm = false; }}>
          Cancel
        </button>
        <button type="submit" class="submit-btn" disabled={!newChoreText.trim()}>
          Add Chore
        </button>
      </div>
    </form>
  {:else}
    <button class="add-btn" onclick={() => { showAddForm = true; }}>
      + Add Today's Chore
    </button>
  {/if}
</div>
```

Add CSS for the form:
```css
.add-section {
  margin-bottom: 1.5rem;
}

.add-btn {
  width: 100%;
  padding: 0.75rem;
  background: #fff;
  border: 2px dashed #4caf50;
  border-radius: 8px;
  color: #4caf50;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s;
}

.add-btn:hover {
  background: #e8f5e9;
}

.add-form {
  background: #fff;
  border-radius: 8px;
  padding: 1rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.add-input {
  width: 100%;
  padding: 0.75rem;
  font-size: 1rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  margin-bottom: 0.75rem;
}

.form-row {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.time-select, .category-input {
  flex: 1;
  padding: 0.5rem;
  font-size: 0.875rem;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.form-actions {
  display: flex;
  gap: 0.5rem;
  justify-content: flex-end;
}

.cancel-btn, .submit-btn {
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
  border-radius: 4px;
  cursor: pointer;
}

.cancel-btn {
  background: #f5f5f5;
  border: 1px solid #ddd;
  color: #666;
}

.submit-btn {
  background: #4caf50;
  border: none;
  color: #fff;
}

.submit-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
}
```

3. Update the handleToggle call to use getCurrentUser():
```typescript
async function handleToggle(id: string) {
  await dailyChoreStore.toggleComplete(id, getCurrentUser());
}
```
  </action>
  <verify>Run `bun run build` to verify no errors. Start dev server, access app, test adding ad-hoc chore.</verify>
  <done>Ad-hoc chore form works; user identity properly flows through for completion and creation attribution</done>
</task>

</tasks>

<verification>
1. `bun run build` completes without errors
2. Access app with valid access key
3. Click "+ Add Today's Chore" button
4. Fill in form with text, time slot, and category
5. Submit - chore appears in correct time slot/category group
6. Verify "Today only" badge appears on the ad-hoc chore
7. Complete the ad-hoc chore - verify name attribution shows correctly
8. Refresh page - ad-hoc chore persists (in IndexedDB and syncs to Convex)
9. Complete a regular chore - verify name attribution from access key
</verification>

<success_criteria>
- Add chore button visible on daily list page
- Form accepts text, time slot, and category
- Ad-hoc chore appears in correct group immediately
- "Today only" badge distinguishes ad-hoc from regular chores
- Completion shows correct user name (from access key displayName)
- Ad-hoc chores sync to Convex and persist across refresh
- Ad-hoc chores only appear for today (not cloned to future days)
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-chore-workflow/04-04-SUMMARY.md`
</output>
