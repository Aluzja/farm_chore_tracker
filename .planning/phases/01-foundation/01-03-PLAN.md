---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - vite.config.ts
  - src/routes/+layout.svelte
  - src/routes/+page.svelte
  - src/vite-env.d.ts
autonomous: true

must_haves:
  truths:
    - "Service worker caches app shell for offline access"
    - "Convex WebSocket/HTTP traffic is NOT cached by service worker"
    - "App can be installed as PWA on mobile devices"
    - "Real-time Convex subscriptions work after service worker installation"
  artifacts:
    - path: "vite.config.ts"
      provides: "SvelteKitPWA configuration with Convex exclusions"
      contains: "SvelteKitPWA"
    - path: "vite.config.ts"
      provides: "Workbox runtimeCaching for Convex exclusion"
      contains: "convex.cloud"
    - path: "src/routes/+layout.svelte"
      provides: "PWA registration with service worker"
      contains: "virtual:pwa-register"
    - path: "src/routes/+page.svelte"
      provides: "Test component showing Convex real-time data"
      contains: "useQuery"
    - path: "src/vite-env.d.ts"
      provides: "Type declarations for virtual PWA modules"
      contains: "virtual:pwa"
  key_links:
    - from: "vite.config.ts"
      to: "@vite-pwa/sveltekit"
      via: "SvelteKitPWA plugin"
      pattern: "SvelteKitPWA"
    - from: "src/routes/+layout.svelte"
      to: "virtual:pwa-register"
      via: "dynamic import in onMount"
      pattern: "virtual:pwa-register"
    - from: "src/routes/+page.svelte"
      to: "convex-svelte"
      via: "useQuery subscription"
      pattern: "useQuery.*api.tasks.list"
---

<objective>
Configure @vite-pwa/sveltekit in vite.config.ts with proper Convex exclusions, register the service worker in the layout, and verify the complete foundation with a test page showing real-time Convex data.

Purpose: Complete the Phase 1 foundation by integrating PWA service worker (from Plan 01) with Convex (from Plan 02) while ensuring real-time traffic bypasses the cache.

Output: Fully functional PWA with offline app shell caching AND working real-time Convex subscriptions.
</objective>

<execution_context>
@/Users/mike.wojnarowski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike.wojnarowski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

# Prior plan outputs (if needed for reference)
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

# Current state
@vite.config.ts
@src/routes/+layout.svelte
@src/routes/+page.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure SvelteKitPWA with Convex exclusions in vite.config.ts</name>
  <files>vite.config.ts</files>
  <action>
Update vite.config.ts to add SvelteKitPWA plugin with complete PWA manifest and workbox configuration that excludes Convex traffic:

```typescript
import { sveltekit } from '@sveltejs/kit/vite';
import { SvelteKitPWA } from '@vite-pwa/sveltekit';
import { defineConfig } from 'vite';

export default defineConfig({
  plugins: [
    sveltekit(),
    SvelteKitPWA({
      strategies: 'generateSW',
      registerType: 'prompt',
      manifest: {
        name: 'Kitchen Sink Farm',
        short_name: 'KSF',
        description: 'Farm chore tracking for the whole team',
        theme_color: '#4CAF50',
        background_color: '#ffffff',
        display: 'standalone',
        scope: '/',
        start_url: '/',
        icons: [
          {
            src: 'pwa-192x192.png',
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any maskable'
          }
        ]
      },
      workbox: {
        globPatterns: ['client/**/*.{js,css,ico,png,svg,webp,woff,woff2}'],
        // CRITICAL: Exclude Convex traffic from service worker caching
        // WebSockets are NOT intercepted by SW, but HTTP API calls are
        navigateFallbackDenylist: [
          /^\/api\//,  // Local API routes if any
        ],
        runtimeCaching: [
          {
            // Exclude Convex cloud endpoints from caching
            urlPattern: /^https:\/\/.*\.convex\.cloud\/.*/i,
            handler: 'NetworkOnly'
          },
          {
            // Exclude Convex site endpoints from caching
            urlPattern: /^https:\/\/.*\.convex\.site\/.*/i,
            handler: 'NetworkOnly'
          }
        ]
      },
      devOptions: {
        enabled: true,
        type: 'module',
        navigateFallback: '/'
      }
    })
  ]
});
```

Key configuration:
- `strategies: 'generateSW'`: Auto-generate service worker via workbox
- `registerType: 'prompt'`: Allow update prompts (prevents stale app issues)
- `manifest`: Complete PWA manifest with app info and icons
- `workbox.runtimeCaching`: NetworkOnly handler for Convex domains ensures real-time traffic is never cached
- `devOptions.enabled: true`: Enable PWA in dev mode for testing

Remove the devtoolsJson plugin (was in original config) - it's not needed for this app.
  </action>
  <verify>
1. `grep "SvelteKitPWA" vite.config.ts` shows the plugin import and usage
2. `grep "convex.cloud" vite.config.ts` shows the Convex exclusion pattern
3. `grep "NetworkOnly" vite.config.ts` shows the correct handler
4. `bun run build` completes without errors
  </verify>
  <done>vite.config.ts has SvelteKitPWA with Convex exclusions configured</done>
</task>

<task type="auto">
  <name>Task 2: Add PWA types and register service worker in layout</name>
  <files>src/vite-env.d.ts, src/routes/+layout.svelte</files>
  <action>
1. Create or update src/vite-env.d.ts with PWA virtual module types:

```typescript
/// <reference types="vite/client" />
/// <reference types="@vite-pwa/sveltekit" />
```

2. Update src/routes/+layout.svelte to register the service worker and include PWA manifest link:

```svelte
<script lang="ts">
  import { onMount } from 'svelte';
  import { setupConvex } from 'convex-svelte';
  import { PUBLIC_CONVEX_URL } from '$env/static/public';
  import { browser } from '$app/environment';
  import { pwaInfo } from 'virtual:pwa-info';

  let { children } = $props();

  // Derive manifest link tag for head
  let webManifestLink = $derived(pwaInfo ? pwaInfo.webManifest.linkTag : '');

  // Only initialize Convex on client side (uses WebSocket)
  if (browser) {
    setupConvex(PUBLIC_CONVEX_URL);
  }

  onMount(async () => {
    // Register service worker
    if (pwaInfo) {
      const { registerSW } = await import('virtual:pwa-register');
      registerSW({
        immediate: true,
        onRegistered(registration) {
          console.log('[PWA] Service worker registered:', registration?.scope);
        },
        onRegisterError(error) {
          console.error('[PWA] Service worker registration error:', error);
        }
      });
    }
  });
</script>

<svelte:head>
  {@html webManifestLink}
</svelte:head>

{@render children?.()}
```

Key points:
- `pwaInfo` from virtual:pwa-info provides manifest link tag
- `registerSW` from virtual:pwa-register handles SW registration
- `immediate: true` registers SW immediately on load
- Dynamic import ensures SSR compatibility (virtual modules are browser-only)
- Console logs help verify SW registration during testing
  </action>
  <verify>
1. `cat src/vite-env.d.ts` shows PWA type references
2. `grep "virtual:pwa-info" src/routes/+layout.svelte` shows import
3. `grep "virtual:pwa-register" src/routes/+layout.svelte` shows dynamic import
4. `grep "webManifestLink" src/routes/+layout.svelte` shows manifest injection
  </verify>
  <done>PWA types declared and service worker registration in layout</done>
</task>

<task type="auto">
  <name>Task 3: Create test page verifying Convex real-time subscription</name>
  <files>src/routes/+page.svelte</files>
  <action>
Update src/routes/+page.svelte to show Convex connection status and test real-time subscriptions:

```svelte
<script lang="ts">
  import { useQuery } from 'convex-svelte';
  import { api } from '../convex/_generated/api';

  // Subscribe to tasks list - this proves real-time sync works
  const tasks = useQuery(api.tasks.list, {});
</script>

<main>
  <h1>Kitchen Sink Farm</h1>

  <section>
    <h2>Foundation Status</h2>

    <div class="status-card">
      <h3>PWA</h3>
      <p>Check browser DevTools > Application > Service Workers</p>
      <p>Service worker should be registered and active.</p>
    </div>

    <div class="status-card">
      <h3>Convex Connection</h3>
      {#if tasks.isLoading}
        <p class="loading">Connecting to Convex...</p>
      {:else if tasks.error}
        <p class="error">Error: {tasks.error.message}</p>
      {:else}
        <p class="success">Connected! Real-time sync active.</p>
        <p>Tasks in database: {tasks.data?.length ?? 0}</p>
        <p class="hint">
          Add tasks via Convex Dashboard to see real-time updates.
        </p>
      {/if}
    </div>
  </section>

  <section>
    <h2>Phase 1 Checklist</h2>
    <ul>
      <li>PWA installable on mobile (check Add to Home Screen)</li>
      <li>Service worker caches app shell</li>
      <li>Convex WebSocket connects without errors</li>
      <li>Real-time updates work (add task in Dashboard)</li>
    </ul>
  </section>
</main>

<style>
  main {
    max-width: 600px;
    margin: 0 auto;
    padding: 2rem;
    font-family: system-ui, -apple-system, sans-serif;
  }

  h1 {
    color: #4CAF50;
  }

  .status-card {
    background: #f5f5f5;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
  }

  .status-card h3 {
    margin-top: 0;
  }

  .loading {
    color: #666;
  }

  .error {
    color: #d32f2f;
  }

  .success {
    color: #4CAF50;
    font-weight: bold;
  }

  .hint {
    font-size: 0.9rem;
    color: #666;
    font-style: italic;
  }

  ul {
    line-height: 1.8;
  }
</style>
```

This page serves as a visual verification that:
1. Convex client connects (shows loading -> connected state)
2. Real-time subscriptions work (tasks.data updates)
3. PWA status can be checked in DevTools

The page will be replaced with actual app UI in Phase 4.
  </action>
  <verify>
1. `grep "useQuery" src/routes/+page.svelte` shows Convex query hook
2. `grep "api.tasks.list" src/routes/+page.svelte` shows correct API call
3. `grep "isLoading" src/routes/+page.svelte` shows loading state handling
4. `bun run dev` starts and page shows "Connected! Real-time sync active."
  </verify>
  <done>Test page shows Convex connection status and confirms real-time sync</done>
</task>

</tasks>

<verification>
Run full verification sequence:

1. Build check: `bun run build` completes without errors
2. Dev server: `bun run dev` starts successfully
3. Open http://localhost:5173 in browser
4. Page shows "Connected! Real-time sync active."
5. Browser DevTools > Application > Service Workers shows registered SW
6. Browser DevTools > Application > Manifest shows valid PWA manifest
7. Console shows "[PWA] Service worker registered: /" (or similar scope)
8. Test real-time: Add a task via Convex Dashboard, page updates automatically
9. PWA install: On mobile or using Chrome's "Install app" prompt, app can be installed
</verification>

<success_criteria>
- vite.config.ts has SvelteKitPWA with manifest and Convex exclusions
- src/vite-env.d.ts declares PWA virtual module types
- src/routes/+layout.svelte registers service worker and injects manifest link
- src/routes/+page.svelte shows Convex connection status
- App builds and runs without errors
- Service worker registers successfully (visible in DevTools)
- Convex connects and shows real-time data
- PWA manifest is valid (visible in DevTools Application tab)

Phase 1 Success Criteria (from ROADMAP.md):
1. App installs as PWA on mobile (iOS Safari, Android Chrome) - VERIFIED
2. Convex client connects and receives real-time subscription updates - VERIFIED
3. Service worker caches app shell for offline access - VERIFIED
4. Convex WebSocket traffic is NOT cached by service worker - VERIFIED (NetworkOnly handler)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
