---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - convex.json
  - src/convex/schema.ts
  - src/convex/tasks.ts
  - src/routes/+layout.svelte
  - .env.local
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Convex client initializes on browser only (not during SSR)"
    - "Convex deployment is created and URL is configured"
    - "A test query can fetch data from Convex in real-time"
  artifacts:
    - path: "package.json"
      provides: "convex and convex-svelte dependencies"
      contains: "convex-svelte"
    - path: "convex.json"
      provides: "Convex configuration pointing to src/convex/"
      contains: '"functions": "src/convex/"'
    - path: "src/convex/schema.ts"
      provides: "Convex schema definition"
      contains: "defineSchema"
    - path: "src/convex/tasks.ts"
      provides: "Sample query function for testing"
      contains: "query"
    - path: "src/routes/+layout.svelte"
      provides: "Convex client initialization with browser guard"
      contains: "setupConvex"
    - path: ".env.local"
      provides: "PUBLIC_CONVEX_URL environment variable"
      contains: "PUBLIC_CONVEX_URL"
  key_links:
    - from: "src/routes/+layout.svelte"
      to: "$env/static/public"
      via: "PUBLIC_CONVEX_URL import"
      pattern: "PUBLIC_CONVEX_URL"
    - from: "src/routes/+layout.svelte"
      to: "convex-svelte"
      via: "setupConvex call"
      pattern: "setupConvex"
---

<objective>
Install Convex dependencies, create a Convex deployment, set up the schema and a test query, and initialize the Convex client in the root layout with proper SSR guards.

Purpose: Establish the real-time database connection that will power all data synchronization. The client must only initialize in the browser since Convex uses WebSocket connections.

Output: Working Convex integration with a test query that confirms real-time subscriptions work.
</objective>

<execution_context>
@/Users/mike.wojnarowski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike.wojnarowski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

# Current state
@src/routes/+layout.svelte
@package.json
@vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Convex dependencies and create deployment</name>
  <files>package.json, convex.json</files>
  <action>
1. Install Convex packages using bun:

```bash
bun add convex convex-svelte
```

2. Create convex.json in project root to configure functions directory for SvelteKit compatibility (functions must be inside src/ for SvelteKit to access them):

```json
{
  "functions": "src/convex/"
}
```

3. Initialize Convex deployment. Run:

```bash
bunx convex dev --once
```

This will:
- Create the src/convex/ directory with _generated/ folder
- Prompt for Convex login (if not already logged in)
- Create a new project or link to existing one
- Generate the deployment URL

If the command requires interactive login, it will open a browser. The deployment URL will be output and should be saved to .env.local.

4. Create .env.local with the Convex deployment URL:

```bash
PUBLIC_CONVEX_URL=https://[your-deployment].convex.cloud
```

Replace [your-deployment] with the actual deployment name from the `bunx convex dev --once` output.

5. Update .gitignore to exclude .env.local (if not already excluded):

```
# Environment
.env.local
.env.*.local
```

IMPORTANT: If `bunx convex dev --once` fails due to needing authentication, note this as a checkpoint requirement for the user to complete login.
  </action>
  <verify>
1. `bun pm ls | grep convex` shows convex and convex-svelte installed
2. `cat convex.json` shows functions pointing to src/convex/
3. `ls src/convex/_generated/` shows generated files (api.d.ts, api.js, etc.)
4. `cat .env.local | grep PUBLIC_CONVEX_URL` shows the deployment URL
  </verify>
  <done>Convex packages installed, deployment created, and URL configured in .env.local</done>
</task>

<task type="auto">
  <name>Task 2: Create Convex schema and test query</name>
  <files>src/convex/schema.ts, src/convex/tasks.ts</files>
  <action>
1. Create src/convex/schema.ts with a minimal tasks table for testing:

```typescript
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  // Test table - will be replaced with actual schema in Phase 4
  tasks: defineTable({
    text: v.string(),
    isCompleted: v.boolean(),
  }),
});
```

2. Create src/convex/tasks.ts with a list query for testing real-time subscriptions:

```typescript
import { query } from "./_generated/server";

export const list = query({
  args: {},
  handler: async (ctx) => {
    return await ctx.db.query("tasks").collect();
  },
});
```

3. Push the schema to Convex:

```bash
bunx convex dev --once
```

This regenerates types in _generated/ and pushes the schema.
  </action>
  <verify>
1. `cat src/convex/schema.ts` shows tasks table definition
2. `cat src/convex/tasks.ts` shows list query
3. `bunx convex dev --once` completes without errors
4. `ls src/convex/_generated/api.d.ts` exists with type definitions
  </verify>
  <done>Convex schema and test query exist and are pushed to deployment</done>
</task>

<task type="auto">
  <name>Task 3: Initialize Convex client in root layout</name>
  <files>src/routes/+layout.svelte</files>
  <action>
Update src/routes/+layout.svelte to initialize Convex client-side only:

```svelte
<script lang="ts">
  import { setupConvex } from 'convex-svelte';
  import { PUBLIC_CONVEX_URL } from '$env/static/public';
  import { browser } from '$app/environment';

  let { children } = $props();

  // Only initialize Convex on client side (uses WebSocket)
  if (browser) {
    setupConvex(PUBLIC_CONVEX_URL);
  }
</script>

{@render children?.()}
```

Key points:
- Remove the old favicon import (will use static/favicon.ico via app.html instead)
- Use `browser` guard from `$app/environment` to prevent SSR initialization
- `setupConvex` sets up the global Convex client that `useQuery` hooks will use
- PUBLIC_CONVEX_URL must be prefixed with PUBLIC_ for SvelteKit to expose it to client

Note: We removed the svelte:head favicon since app.html now handles that.
  </action>
  <verify>
1. `grep "setupConvex" src/routes/+layout.svelte` shows the import and call
2. `grep "browser" src/routes/+layout.svelte` shows the SSR guard
3. `grep "PUBLIC_CONVEX_URL" src/routes/+layout.svelte` shows env var import
4. `bun run build` completes without SSR errors
  </verify>
  <done>Convex client initializes in browser only via root layout</done>
</task>

</tasks>

<verification>
1. `bun pm ls | grep convex` shows both convex and convex-svelte
2. `cat convex.json` shows `"functions": "src/convex/"`
3. `ls src/convex/` shows schema.ts, tasks.ts, and _generated/
4. `cat .env.local` shows PUBLIC_CONVEX_URL
5. `bun run build` completes without errors
6. `bun run dev` starts and browser console shows no Convex errors
</verification>

<success_criteria>
- convex and convex-svelte are in package.json dependencies
- convex.json configures functions in src/convex/
- src/convex/schema.ts defines tasks table
- src/convex/tasks.ts exports list query
- src/routes/+layout.svelte initializes Convex with browser guard
- .env.local contains PUBLIC_CONVEX_URL
- App builds and runs without SSR errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
