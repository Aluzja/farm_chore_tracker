---
phase: 06-polish-and-history
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/convex/dailyChores.ts
  - src/routes/(app)/history/+page.svelte
  - src/routes/(app)/+layout.svelte
autonomous: true

must_haves:
  truths:
    - "User can navigate to history view from main UI"
    - "User can view completed chores from past 7 days"
    - "History shows completion photos as thumbnails"
    - "History shows who completed each chore and when"
    - "History groups chores by date with clear date headers"
  artifacts:
    - path: "src/convex/dailyChores.ts"
      provides: "getHistory query for past N days"
      exports: ["getHistory"]
    - path: "src/routes/(app)/history/+page.svelte"
      provides: "7-day history view with date navigation"
      min_lines: 80
  key_links:
    - from: "src/routes/(app)/history/+page.svelte"
      to: "getHistory"
      via: "Convex useQuery"
      pattern: "useQuery.*getHistory"
    - from: "src/routes/(app)/history/+page.svelte"
      to: "PhotoThumbnail"
      via: "component for completed chore photos"
      pattern: "PhotoThumbnail"
    - from: "src/routes/(app)/+layout.svelte"
      to: "/history"
      via: "navigation link"
      pattern: "resolve.*history"
---

<objective>
Create a 7-day history view that shows completed chores with photos, timestamps, and completion info grouped by date.

Purpose: Users need to review past work - what was done, when, by whom, and with photo proof. This provides accountability and helps with farm management.

Output: Convex getHistory query, history page with date-grouped display, navigation link from main UI.
</objective>

<execution_context>
@/Users/mike.wojnarowski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike.wojnarowski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-polish-and-history/06-RESEARCH.md
@src/convex/dailyChores.ts
@src/convex/schema.ts
@src/lib/components/PhotoThumbnail.svelte
@src/routes/(app)/+layout.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getHistory query to Convex</name>
  <files>src/convex/dailyChores.ts</files>
  <action>
Add a getHistory query to fetch completed chores from the past N days:

```typescript
export const getHistory = query({
  args: { daysBack: v.optional(v.number()) },
  handler: async (ctx, { daysBack = 7 }) => {
    const today = new Date();
    const startDate = new Date(today);
    startDate.setDate(today.getDate() - daysBack);
    const startDateStr = startDate.toISOString().split('T')[0];

    // Get completed chores from startDate onwards
    const chores = await ctx.db
      .query("dailyChores")
      .withIndex("by_date", (q) => q.gte("date", startDateStr))
      .filter((q) => q.eq(q.field("isCompleted"), true))
      .collect();

    // Sort by date descending, then by completedAt descending
    return chores.sort((a, b) => {
      if (a.date !== b.date) return b.date.localeCompare(a.date);
      const aTime = a.completedAt ?? '';
      const bTime = b.completedAt ?? '';
      return bTime.localeCompare(aTime);
    });
  },
});
```

The by_date index supports gte (greater than or equal) queries efficiently.
  </action>
  <verify>Run `npx convex dev`, query appears in dashboard. Test query returns completed chores only.</verify>
  <done>getHistory query returns completed chores from past 7 days, sorted by date descending.</done>
</task>

<task type="auto">
  <name>Task 2: Create history page with date-grouped display</name>
  <files>src/routes/(app)/history/+page.svelte</files>
  <action>
Create the history page at src/routes/(app)/history/+page.svelte:

Structure:
1. Header with "History" title and back navigation
2. Loading state while fetching
3. Empty state if no completed chores
4. Date-grouped list of completed chores

Use Convex useQuery to fetch getHistory:
```svelte
<script lang="ts">
  import { useQuery } from 'convex-svelte';
  import { api } from '$convex/_generated/api';
  import PhotoThumbnail from '$lib/components/PhotoThumbnail.svelte';
  import { resolve } from '$app/paths';

  const history = useQuery(api.dailyChores.getHistory, { daysBack: 7 });

  // Group chores by date
  const grouped = $derived(() => {
    if (!history.data) return [];
    const groups = new Map<string, typeof history.data>();
    for (const chore of history.data) {
      if (!groups.has(chore.date)) groups.set(chore.date, []);
      groups.get(chore.date)!.push(chore);
    }
    return Array.from(groups.entries()).map(([date, chores]) => ({
      date,
      displayDate: formatDisplayDate(date),
      chores
    }));
  });
</script>
```

Date display helpers:
- formatDisplayDate(date): "Today", "Yesterday", or "Mon, Feb 1"
- formatTime(isoString): "2:30 PM"

Each chore card shows:
- Chore text
- Time slot and category (small text)
- Completed by + time
- PhotoThumbnail if photoStorageId exists (reuse existing component)

Use sticky date headers for scroll context (position: sticky).

Styling:
- Scoped CSS, no Tailwind
- Cards with subtle shadows
- Photo thumbnails on right side of card
- Touch-friendly spacing (min 48px row height)
  </action>
  <verify>Navigate to /history, see completed chores grouped by date with photos loading as thumbnails.</verify>
  <done>History page displays 7 days of completed chores grouped by date with photos and completion info.</done>
</task>

<task type="auto">
  <name>Task 3: Add navigation link to history</name>
  <files>src/routes/(app)/+layout.svelte</files>
  <action>
Add a navigation link to the history page in the app layout:

1. Add a history link in the header or footer navigation
2. Use resolve('/history') for the href (SvelteKit navigation pattern)
3. Style as subtle link or icon button

If there's a bottom navigation bar pattern, add history icon there.
If header only, add "History" link next to any existing navigation.

Icon option (simple clock SVG):
```svelte
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
  <circle cx="12" cy="12" r="10"></circle>
  <polyline points="12 6 12 12 16 14"></polyline>
</svg>
```

Ensure the link works from any page in the (app) route group.
  </action>
  <verify>From main chore list, tap history link, navigate to /history page.</verify>
  <done>Navigation to history page is accessible from main app UI.</done>
</task>

</tasks>

<verification>
1. Run `npm run dev`
2. Complete several chores over different "days" (or use existing test data)
3. Navigate to history via new navigation link
4. Verify chores are grouped by date (most recent first)
5. Verify completed photos show as thumbnails
6. Verify "who completed" and "when" info is visible
7. Tap a photo thumbnail to verify it opens photo view
</verification>

<success_criteria>
- getHistory query returns completed chores from past 7 days
- History page loads and displays chores grouped by date
- Date headers show "Today", "Yesterday", or formatted date
- Each chore shows completion info (who, when)
- PhotoThumbnail renders for chores with photos
- Navigation link from main UI to history works
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish-and-history/06-02-SUMMARY.md`
</output>
