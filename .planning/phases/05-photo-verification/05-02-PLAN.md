---
phase: 05-photo-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/convex/schema.ts
  - src/convex/photos.ts
  - src/convex/masterChores.ts
  - src/convex/dailyChores.ts
autonomous: true

must_haves:
  truths:
    - "Master chores can be configured with requiresPhoto flag"
    - "Daily chores track photoStorageId for completed photos"
    - "Convex generates upload URLs for photo storage"
    - "Photo URLs can be retrieved for viewing"
  artifacts:
    - path: "src/convex/schema.ts"
      provides: "requiresPhoto and photo fields on chore tables"
      contains: "requiresPhoto"
    - path: "src/convex/photos.ts"
      provides: "Photo upload and retrieval API"
      exports: ["generateUploadUrl", "attachPhotoToChore", "getPhotoUrl"]
  key_links:
    - from: "src/convex/photos.ts"
      to: "ctx.storage"
      via: "Convex file storage API"
      pattern: "ctx.storage.generateUploadUrl"
    - from: "src/convex/photos.ts"
      to: "dailyChores table"
      via: "database patch for photoStorageId"
      pattern: "ctx.db.patch"
---

<objective>
Extend Convex schema with photo fields and create photo storage API for upload URL generation and photo retrieval.

Purpose: Backend support for photo verification - storing which chores require photos and linking uploaded photos to completed chores.
Output: Extended Convex schema with photo fields, photos.ts with upload/retrieval mutations and queries.
</objective>

<execution_context>
@/Users/mike.wojnarowski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike.wojnarowski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-photo-verification/05-RESEARCH.md

@src/convex/schema.ts
@src/convex/masterChores.ts
@src/convex/dailyChores.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Convex schema with photo fields</name>
  <files>
    src/convex/schema.ts
  </files>
  <action>
Update `src/convex/schema.ts`:

1. Add to masterChores table:
```typescript
requiresPhoto: v.optional(v.boolean()), // Admin configures if photo proof needed
```

2. Add to dailyChores table:
```typescript
requiresPhoto: v.boolean(),            // Copied from master on clone
photoStorageId: v.optional(v.id("_storage")), // Convex file storage ID
photoCapturedAt: v.optional(v.number()), // When photo was taken
photoCapturedBy: v.optional(v.string()), // Who took the photo
```

The requiresPhoto field on dailyChores is not optional (defaults to false on clone).
The photoStorageId links to Convex's built-in _storage table for file uploads.

After changes, run `npx convex dev --once` to deploy schema updates.
  </action>
  <verify>
Run `npx convex dev --once` - should deploy schema successfully.
Run `npm run build` - should compile without errors.
Check src/convex/_generated/api.d.ts includes updated types.
  </verify>
  <done>
Convex schema includes requiresPhoto on masterChores and dailyChores.
Convex schema includes photoStorageId, photoCapturedAt, photoCapturedBy on dailyChores.
Schema deployed to Convex.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Convex photos API</name>
  <files>
    src/convex/photos.ts
  </files>
  <action>
Create `src/convex/photos.ts` with:

1. `generateUploadUrl` mutation:
```typescript
import { mutation, query } from "./_generated/server";
import { v } from "convex/values";

// Generate a short-lived URL for uploading a photo
export const generateUploadUrl = mutation({
  args: {},
  handler: async (ctx) => {
    return await ctx.storage.generateUploadUrl();
  },
});
```

2. `attachPhotoToChore` mutation:
```typescript
// Attach uploaded photo to a daily chore
export const attachPhotoToChore = mutation({
  args: {
    dailyChoreClientId: v.string(),
    storageId: v.id("_storage"),
    capturedAt: v.number(),
    capturedBy: v.string(),
  },
  handler: async (ctx, args) => {
    const chore = await ctx.db
      .query("dailyChores")
      .withIndex("by_client_id", (q) => q.eq("clientId", args.dailyChoreClientId))
      .first();

    if (!chore) {
      throw new Error(`Daily chore not found: ${args.dailyChoreClientId}`);
    }

    await ctx.db.patch(chore._id, {
      photoStorageId: args.storageId,
      photoCapturedAt: args.capturedAt,
      photoCapturedBy: args.capturedBy,
    });

    return { success: true };
  },
});
```

3. `getPhotoUrl` query:
```typescript
// Get the serving URL for a photo
export const getPhotoUrl = query({
  args: { storageId: v.id("_storage") },
  handler: async (ctx, { storageId }) => {
    return await ctx.storage.getUrl(storageId);
  },
});
```

4. `getPhotoUrlByChore` query (convenience):
```typescript
// Get photo URL for a specific daily chore
export const getPhotoUrlByChore = query({
  args: { dailyChoreClientId: v.string() },
  handler: async (ctx, { dailyChoreClientId }) => {
    const chore = await ctx.db
      .query("dailyChores")
      .withIndex("by_client_id", (q) => q.eq("clientId", dailyChoreClientId))
      .first();

    if (!chore?.photoStorageId) {
      return null;
    }

    return await ctx.storage.getUrl(chore.photoStorageId);
  },
});
```

Reference: Research section "Pattern 2: Convex Upload URL Flow"
  </action>
  <verify>
Run `npx convex dev --once` - should deploy functions successfully.
Run `npm run build` - should compile without errors.
Check src/convex/_generated/api.d.ts includes photos namespace.
  </verify>
  <done>
Convex photos.ts with generateUploadUrl, attachPhotoToChore, getPhotoUrl, getPhotoUrlByChore.
All functions deployed and available via api.photos namespace.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update chore cloning to copy requiresPhoto</name>
  <files>
    src/convex/dailyChores.ts
    src/convex/masterChores.ts
  </files>
  <action>
Update `src/convex/dailyChores.ts`:

In the `cloneMasterToDaily` internal mutation (or wherever daily chores are created from master):
- Add `requiresPhoto: master.requiresPhoto ?? false` to the dailyChore document

Update `src/convex/masterChores.ts`:

In the `create` mutation:
- Accept optional `requiresPhoto: v.optional(v.boolean())` argument
- Store it on the master chore document

In the `update` mutation:
- Accept optional `requiresPhoto: v.optional(v.boolean())` argument
- Allow updating the field

Ensure ad-hoc chores in `addAdHoc` default to `requiresPhoto: false` since they're created on-the-fly without photo requirements.

Run `npx convex dev --once` after changes to deploy.
  </action>
  <verify>
Run `npx convex dev --once` - should deploy successfully.
Run `npm run build` - should compile without errors.
Check that daily chores cloned from master include requiresPhoto field.
  </verify>
  <done>
Daily chore cloning copies requiresPhoto from master.
Master chore CRUD supports requiresPhoto field.
Ad-hoc chores default to requiresPhoto: false.
  </done>
</task>

</tasks>

<verification>
1. `npx convex dev --once` deploys schema and functions without errors
2. `npm run build` completes without errors
3. src/convex/schema.ts has requiresPhoto on masterChores and dailyChores
4. src/convex/schema.ts has photoStorageId on dailyChores
5. src/convex/photos.ts exports generateUploadUrl, attachPhotoToChore, getPhotoUrl, getPhotoUrlByChore
6. src/convex/dailyChores.ts clones requiresPhoto from master
7. Generated api.d.ts includes photos namespace
</verification>

<success_criteria>
- Convex schema supports photo verification fields
- Photo upload URL can be generated via mutation
- Photos can be attached to daily chores
- Photo URLs can be retrieved for viewing
- Master-to-daily cloning preserves requiresPhoto setting
</success_criteria>

<output>
After completion, create `.planning/phases/05-photo-verification/05-02-SUMMARY.md`
</output>
