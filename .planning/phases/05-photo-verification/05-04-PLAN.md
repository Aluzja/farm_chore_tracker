---
phase: 05-photo-verification
plan: 04
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - src/lib/stores/dailyChores.svelte.ts
  - src/routes/(app)/+page.svelte
  - src/routes/(app)/photo-capture/+page.svelte
  - src/routes/(app)/photo-view/[id]/+page.svelte
autonomous: false

must_haves:
  truths:
    - "User can tap a chore to open camera and capture photo"
    - "Photo preview shows with accept/retake options"
    - "Required-photo chores cannot be completed without photo"
    - "Completed chore photos display as thumbnails"
    - "Tapping thumbnail opens full photo view with zoom"
  artifacts:
    - path: "src/routes/(app)/photo-capture/+page.svelte"
      provides: "Camera capture page with preview"
      contains: "capturePhoto"
    - path: "src/routes/(app)/photo-view/[id]/+page.svelte"
      provides: "Photo viewing page with zoom and download"
      contains: "photoUrl"
    - path: "src/routes/(app)/+page.svelte"
      provides: "Chore list with photo thumbnails and capture flow"
      contains: "photoStorageId"
  key_links:
    - from: "src/routes/(app)/+page.svelte"
      to: "src/routes/(app)/photo-capture/+page.svelte"
      via: "navigation on chore tap"
      pattern: "goto.*photo-capture"
    - from: "src/routes/(app)/photo-capture/+page.svelte"
      to: "src/lib/photo/capture.ts"
      via: "camera capture function"
      pattern: "capturePhoto"
    - from: "src/routes/(app)/+page.svelte"
      to: "src/routes/(app)/photo-view/[id]/+page.svelte"
      via: "navigation on thumbnail tap"
      pattern: "photo-view"
---

<objective>
Integrate photo capture into the worker chore completion flow with camera UI, preview, photo requirement enforcement, and photo viewing.

Purpose: Complete user-facing photo verification feature - workers can take photos when completing chores, and required-photo chores enforce photo capture.
Output: Photo capture page, photo view page, updated chore list with photo thumbnails and capture flow.
</objective>

<execution_context>
@/Users/mike.wojnarowski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike.wojnarowski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-photo-verification/05-RESEARCH.md
@.planning/phases/05-photo-verification/05-CONTEXT.md

@src/routes/(app)/+page.svelte
@src/lib/stores/dailyChores.svelte.ts
@src/lib/photo/capture.ts
@src/lib/photo/queue.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create photo capture page with preview flow</name>
  <files>
    src/routes/(app)/photo-capture/+page.svelte
  </files>
  <action>
Create `src/routes/(app)/photo-capture/+page.svelte`:

This page handles the full capture flow from CONTEXT.md:
- Tap chore -> camera -> preview with accept/retake -> chore marked complete with photo attached

Use SvelteKit page params to receive the daily chore ID:
```svelte
<script lang="ts">
  import { page } from '$app/stores';
  import { goto } from '$app/navigation';
  import { resolve } from '$app/paths';
  import { capturePhoto, compressImage } from '$lib/photo/capture';
  import { enqueuePhoto } from '$lib/photo/queue';
  import { dailyChoreStore } from '$lib/stores/dailyChores.svelte';
  import { getCurrentUser } from '$lib/auth/user-context.svelte';
  import { syncEngine } from '$lib/sync/engine.svelte';
  import { connectionStatus } from '$lib/sync/status.svelte';

  // Get chore ID from query params
  const choreId = $page.url.searchParams.get('choreId');

  let previewUrl = $state<string | null>(null);
  let capturedBlob = $state<Blob | null>(null);
  let originalSize = $state(0);
  let isCapturing = $state(false);
  let isSubmitting = $state(false);
  let error = $state<string | null>(null);

  // Find the chore to display its name
  const chore = $derived(dailyChoreStore.all.find(c => c._id === choreId));

  async function handleCapture() {
    isCapturing = true;
    error = null;

    try {
      const result = await capturePhoto();
      if (result) {
        previewUrl = result.previewUrl;
        capturedBlob = result.blob;
        originalSize = result.originalSize;
      } else {
        // User cancelled
        await goto(resolve('/'));
      }
    } catch (e) {
      error = e instanceof Error ? e.message : 'Failed to capture photo';
    } finally {
      isCapturing = false;
    }
  }

  async function handleRetake() {
    if (previewUrl) {
      URL.revokeObjectURL(previewUrl);
    }
    previewUrl = null;
    capturedBlob = null;
    await handleCapture();
  }

  async function handleAccept() {
    if (!capturedBlob || !choreId) return;

    isSubmitting = true;
    error = null;

    try {
      const user = getCurrentUser();
      const capturedAt = Date.now();

      // Queue photo for upload
      await enqueuePhoto({
        id: crypto.randomUUID(),
        dailyChoreClientId: choreId,
        blob: capturedBlob,
        mimeType: 'image/jpeg',
        originalSize,
        compressedSize: capturedBlob.size,
        capturedAt,
        capturedBy: user,
        uploadStatus: 'pending',
      });

      // Mark chore as complete
      await dailyChoreStore.toggleComplete(choreId, user);

      // Trigger sync if online
      if (connectionStatus.isOnline) {
        syncEngine.processQueue();
      }

      // Navigate back to chore list
      await goto(resolve('/'));
    } catch (e) {
      error = e instanceof Error ? e.message : 'Failed to save photo';
      isSubmitting = false;
    }
  }

  function handleCancel() {
    if (previewUrl) {
      URL.revokeObjectURL(previewUrl);
    }
    goto(resolve('/'));
  }

  // Auto-trigger capture on mount
  $effect(() => {
    if (!previewUrl && !isCapturing) {
      handleCapture();
    }
  });
</script>
```

Template with preview and accept/retake buttons:
- Show chore name at top
- Large preview image
- Accept button (green, prominent)
- Retake button (secondary)
- Cancel button to go back without completing

Style with scoped CSS (NO Tailwind):
- Full-screen modal-like layout
- Large touch targets for field use
- Preview image fills available space
- Buttons at bottom in a row

Reference: CONTEXT.md decisions for capture experience
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Verify page exists at src/routes/(app)/photo-capture/+page.svelte.
Verify it imports from $lib/photo/capture and $lib/photo/queue.
  </verify>
  <done>
Photo capture page with camera trigger, preview display, accept/retake flow.
Integrates with photo queue for offline-first storage.
Marks chore complete after photo accepted.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create photo view page with zoom and download</name>
  <files>
    src/routes/(app)/photo-view/[id]/+page.svelte
  </files>
  <action>
Create `src/routes/(app)/photo-view/[id]/+page.svelte`:

This page shows a full-screen view of a completed chore's photo:
- Pinch-to-zoom supported
- Download button to save to device gallery
- Shows who completed and when

```svelte
<script lang="ts">
  import { page } from '$app/stores';
  import { goto } from '$app/navigation';
  import { resolve } from '$app/paths';
  import { useConvexClient } from 'convex-svelte';
  import { api } from '../../../../convex/_generated/api';
  import { dailyChoreStore } from '$lib/stores/dailyChores.svelte';
  import type { Id } from '../../../../convex/_generated/dataModel';

  const client = useConvexClient();
  const choreId = $page.params.id;

  // Find the chore
  const chore = $derived(dailyChoreStore.all.find(c => c._id === choreId));

  let photoUrl = $state<string | null>(null);
  let isLoading = $state(true);
  let error = $state<string | null>(null);

  // Fetch photo URL when chore has photoStorageId
  $effect(() => {
    async function fetchUrl() {
      if (!chore?.photoStorageId) {
        isLoading = false;
        return;
      }

      try {
        // Need to handle the fact that photoStorageId might be stored differently
        // Check if it's a Convex ID or needs conversion
        const url = await client.query(api.photos.getPhotoUrl, {
          storageId: chore.photoStorageId as Id<"_storage">
        });
        photoUrl = url;
      } catch (e) {
        error = e instanceof Error ? e.message : 'Failed to load photo';
      } finally {
        isLoading = false;
      }
    }
    fetchUrl();
  });

  function handleDownload() {
    if (!photoUrl) return;

    const link = document.createElement('a');
    link.href = photoUrl;
    link.download = `chore-${choreId}-${Date.now()}.jpg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function handleBack() {
    goto(resolve('/'));
  }

  function formatDateTime(timestamp: number | undefined): string {
    if (!timestamp) return '';
    return new Date(timestamp).toLocaleString();
  }
</script>
```

Template:
- Back button (top left)
- Photo in scrollable/zoomable container
- Metadata bar showing: completed by, completed at
- Download button (bottom)

For pinch-to-zoom, use CSS touch-action and overflow:
```css
.photo-container {
  touch-action: pinch-zoom;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

.photo-container img {
  max-width: none; /* Allow zoom beyond container */
  transform-origin: 0 0;
}
```

Style with scoped CSS (NO Tailwind).

Reference: CONTEXT.md decisions for photo viewing (download button, pinch-to-zoom, metadata)
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Verify page exists at src/routes/(app)/photo-view/[id]/+page.svelte.
Verify it queries Convex for photo URL.
Verify download function creates anchor with download attribute.
  </verify>
  <done>
Photo view page with full-screen display.
Pinch-to-zoom support via CSS touch-action.
Download button saves photo to device.
Shows completion metadata (who, when).
  </done>
</task>

<task type="auto">
  <name>Task 3: Update chore list with photo capture flow and thumbnails</name>
  <files>
    src/routes/(app)/+page.svelte
    src/lib/stores/dailyChores.svelte.ts
  </files>
  <action>
Update `src/lib/stores/dailyChores.svelte.ts`:

1. Update DailyChore type in store to include photo fields:
   - requiresPhoto: boolean
   - photoStorageId?: string

2. Update hydrateFromServer to map these fields from Convex data.

Update `src/routes/(app)/+page.svelte`:

1. Modify chore tap behavior:
   - If chore.requiresPhoto AND not completed: navigate to photo-capture page
   - If chore.requiresPhoto AND completed with photo: toggle normally (allow undo)
   - If not requiresPhoto: toggle normally

```typescript
async function handleChoreAction(chore: DailyChore) {
  if (chore.requiresPhoto && !chore.isCompleted) {
    // Must take photo - navigate to capture page
    await goto(resolve(`/photo-capture?choreId=${chore._id}`));
  } else {
    // Normal toggle (or undo for completed chores)
    await dailyChoreStore.toggleComplete(chore._id, getCurrentUser());
  }
}
```

2. Add photo thumbnail display next to completed chores that have photos:
   - Small thumbnail (40x40 or 48x48) beside the chore text
   - Tapping thumbnail navigates to photo-view page
   - Use Convex query to get photo URL (can batch or lazy-load)

```svelte
{#if chore.isCompleted && chore.photoStorageId}
  <button
    class="photo-thumbnail"
    onclick={() => goto(resolve(`/photo-view/${chore._id}`))}
    aria-label="View photo"
  >
    <img src={getThumbnailUrl(chore.photoStorageId)} alt="Completion photo" />
  </button>
{/if}
```

3. Add visual indicator for chores that require photo:
   - Camera icon badge next to chore text
   - Different styling for "requires photo" vs regular chores

```svelte
{#if chore.requiresPhoto && !chore.isCompleted}
  <span class="badge photo-required" title="Photo required">
    <svg viewBox="0 0 24 24"><!-- camera icon --></svg>
  </span>
{/if}
```

4. Add photo upload progress indicator to header (near sync indicator):
```svelte
{#if syncEngine.pendingPhotoCount > 0}
  <div class="photo-upload-indicator">
    {syncEngine.currentPhotoUpload ? 'Uploading photo...' : `${syncEngine.pendingPhotoCount} photos`}
  </div>
{/if}
```

Style all new elements with scoped CSS (NO Tailwind).
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Verify chore tap navigates to photo-capture for requiresPhoto chores.
Verify photo thumbnails display for completed chores with photos.
Verify photo upload indicator shows in header.
  </verify>
  <done>
Chore list integrates photo capture flow.
Required-photo chores show camera icon and navigate to capture.
Completed photos show as thumbnails.
Photo upload progress visible in header.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete photo verification flow:
- Camera capture with preview and accept/retake
- Photo queue for offline storage
- Upload to Convex when online
- Photo thumbnails on completed chores
- Full photo view with zoom and download
- Required-photo enforcement
  </what-built>
  <how-to-verify>
1. Navigate to the app as a worker (use access key URL)
2. Find a chore that requires a photo (admin needs to have configured one)
3. Tap the chore - camera should open
4. Take a photo
5. Preview should show with Accept/Retake buttons
6. Tap Accept - chore should mark complete
7. Verify thumbnail appears next to the completed chore
8. Tap thumbnail - photo view page should open
9. Verify pinch-to-zoom works on photo
10. Tap download button - photo should save to device
11. Test offline: turn off network, complete a photo chore
12. Verify photo is queued (upload indicator shows)
13. Turn network back on - photo should upload automatically
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the photo verification flow</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Photo capture page exists and triggers camera
3. Photo view page shows full photo with zoom support
4. Chore list shows photo thumbnails for completed chores
5. Required-photo chores navigate to capture instead of toggling
6. Photo upload progress shows in header
7. Offline photo capture queues for later upload
8. Online photos upload automatically via sync engine
</verification>

<success_criteria>
- User can capture photo during chore completion
- Preview shows with accept/retake options
- Required-photo chores enforce photo before completion
- Completed photos display as thumbnails
- Full photo view supports zoom and download
- Offline photos queue and upload when connected
</success_criteria>

<output>
After completion, create `.planning/phases/05-photo-verification/05-04-SUMMARY.md`
</output>
