---
phase: 05-photo-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/db/schema.ts
  - src/lib/db/client.ts
  - src/lib/photo/capture.ts
autonomous: true

must_haves:
  truths:
    - "Photo can be captured from device camera"
    - "Photos are compressed to ~1MB JPEG before storage"
    - "Photo queue entries can be persisted in IndexedDB"
  artifacts:
    - path: "src/lib/photo/capture.ts"
      provides: "Camera capture and image compression"
      exports: ["capturePhoto", "compressImage"]
    - path: "src/lib/db/schema.ts"
      provides: "PhotoQueueEntry Zod schema"
      contains: "PhotoQueueEntrySchema"
    - path: "src/lib/db/client.ts"
      provides: "photoQueue IndexedDB store"
      contains: "photoQueue"
  key_links:
    - from: "src/lib/photo/capture.ts"
      to: "browser-image-compression"
      via: "imageCompression import"
      pattern: "import imageCompression from 'browser-image-compression'"
---

<objective>
Set up photo capture infrastructure with camera access, image compression, and IndexedDB schema for the photo queue.

Purpose: Foundation for photo verification feature - ability to capture, compress, and persist photos locally before upload.
Output: Photo capture module, compression utility, and extended IndexedDB schema with photoQueue store.
</objective>

<execution_context>
@/Users/mike.wojnarowski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike.wojnarowski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-photo-verification/05-RESEARCH.md

@src/lib/db/schema.ts
@src/lib/db/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install browser-image-compression and create capture module</name>
  <files>
    package.json
    src/lib/photo/capture.ts
  </files>
  <action>
Install browser-image-compression:
```bash
npm install browser-image-compression
```

Create `src/lib/photo/capture.ts` with:

1. `compressImage(file: File): Promise<Blob>` function:
   - Use browser-image-compression with options:
     - maxSizeMB: 1
     - useWebWorker: true
     - preserveExif: false (strips GPS, timestamps - app tracks its own metadata)
     - fileType: 'image/jpeg'
     - initialQuality: 0.85
   - Return compressed Blob
   - Include progress callback for UI feedback

2. `capturePhoto(): Promise<{ blob: Blob; previewUrl: string; originalSize: number } | null>` function:
   - Create hidden file input with:
     - type="file"
     - accept="image/*"
     - capture="environment" (prefer back camera)
   - Trigger click programmatically
   - Capture the original file size BEFORE compression: `const originalSize = file.size`
   - After compression, return object with:
     - blob: the compressed Blob
     - previewUrl: URL.createObjectURL(compressedBlob)
     - originalSize: the pre-compression file size in bytes
   - Return null if user cancels

Export both functions.

Reference: Research section "Pattern 3: Camera Capture with HTML5 Input" and "Image Compression with Progress"
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Check that browser-image-compression is in package.json dependencies.
Check src/lib/photo/capture.ts exports capturePhoto and compressImage.
Verify capturePhoto return type includes { blob: Blob; previewUrl: string; originalSize: number }.
  </verify>
  <done>
Photo capture module exists with camera access and JPEG compression.
Browser-image-compression installed and imported correctly.
capturePhoto returns originalSize field for tracking pre-compression size.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend IndexedDB schema with photoQueue store</name>
  <files>
    src/lib/db/schema.ts
    src/lib/db/client.ts
  </files>
  <action>
Update `src/lib/db/schema.ts`:

1. Bump DB_VERSION from 2 to 3

2. Add PhotoQueueEntrySchema using Zod:
```typescript
export const PhotoQueueEntrySchema = z.object({
  id: z.string(),                              // UUID
  dailyChoreClientId: z.string(),              // Links to dailyChore
  blob: z.instanceof(Blob),                    // Compressed image blob
  mimeType: z.literal('image/jpeg'),
  originalSize: z.number(),                    // Pre-compression size
  compressedSize: z.number(),                  // Post-compression size
  capturedAt: z.number(),                      // Timestamp
  capturedBy: z.string(),                      // User display name
  uploadStatus: z.enum(['pending', 'uploading', 'failed']),
  retryCount: z.number().default(0),
  lastAttemptAt: z.number().optional(),
});

export type PhotoQueueEntry = z.infer<typeof PhotoQueueEntrySchema>;
```

3. Add 'photoQueue' to STORES constant

Update `src/lib/db/client.ts`:

1. Add photoQueue to KitchenSinkDB interface:
```typescript
photoQueue: {
  key: string;
  value: PhotoQueueEntry;
  indexes: {
    'by-upload-status': string;
    'by-captured-at': number;
  };
};
```

2. Add version 3 migration in upgrade function:
```typescript
if (oldVersion < 3) {
  const photoStore = db.createObjectStore(STORES.photoQueue, { keyPath: 'id' });
  photoStore.createIndex('by-upload-status', 'uploadStatus');
  photoStore.createIndex('by-captured-at', 'capturedAt');
}
```

Import PhotoQueueEntry type from schema.
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Run `npm run check` - TypeScript should pass.
Verify DB_VERSION is 3.
Verify PhotoQueueEntrySchema is exported from schema.ts.
Verify KitchenSinkDB includes photoQueue store definition.
  </verify>
  <done>
IndexedDB schema version 3 includes photoQueue store with indexes.
PhotoQueueEntry Zod schema defined and exported.
Database migration handles upgrade from version 2.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run check` passes TypeScript validation
3. browser-image-compression in package.json dependencies
4. src/lib/photo/capture.ts exists with capturePhoto and compressImage exports
5. capturePhoto return type is `{ blob: Blob; previewUrl: string; originalSize: number } | null`
6. src/lib/db/schema.ts has DB_VERSION = 3 and PhotoQueueEntrySchema
7. src/lib/db/client.ts has photoQueue in KitchenSinkDB interface
</verification>

<success_criteria>
- Photo capture module can be imported and used
- capturePhoto returns originalSize for tracking pre-compression file size
- IndexedDB will create photoQueue store on version 3 upgrade
- All TypeScript types are properly defined
- Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-photo-verification/05-01-SUMMARY.md`
</output>
